<!DOCTYPE HTML>
<html>
<head>
    <script type="text/javascript">

        const BASE_CONTROL_PORT = 8008;
        const CONTROL_PORT_POOL = 20;

    const SOCKET_TIMEOUT = 100; //milleseconds
    const RECONNECT_TIMEOUT = 10000; //milleseconds

    var socket = null;
    var socketConnected = false;
    var controlPort = BASE_CONTROL_PORT;
    var clientsPort = 0;
    var timeoutObject = null;
    var tabs = new Set();

    var _clean = function(){
        socket = null;
        socketConnected = false;
        clientsPort = 0;

        if (timeoutObject) {
            clearTimeout(timeoutObject);
        }
        timeoutObject = null;
    }

    var _send = function (obj) {
        try {

            if (socket) {
                socket.send(JSON.stringify(obj));
                console.log("(BeardedSpice Control) Socket send:" + JSON.stringify(obj));
            }
        } catch (ex) {
            logError(ex);
            socket.close();
        }
    };
    var _sendOk = function() { 
        _send({'result':true})
    };

    var logError = function (ex) {
        if (typeof console !== 'undefined' && console.error) {
            console.error('Error in BeardedSpice Control script');
            console.error(ex);
        }
    };

    function reconnect(event) {
        console.info("(BeardedSpice Control) Attempt to reconnecting.");

        _clean();
        connect(controlPort);
    };

    var connectTimeout = function(event) {

        var _socket = socket;
        _clean();
        _socket.close();
        if (controlPort < (BASE_CONTROL_PORT + CONTROL_PORT_POOL)) {
            controlPort++;
            connect(controlPort);
        }
        else {
            controlPort = BASE_CONTROL_PORT;
            timeoutObject = setTimeout(reconnect, RECONNECT_TIMEOUT);
        }
    };

    function connect(port) {

        // Create WebSocket connection.
        var url = 'wss://localhost:'+port;

        if (controlPort == BASE_CONTROL_PORT) {
            console.info("(BeardedSpice Control) Try connect to '" + url + "' with ports pool: " + CONTROL_PORT_POOL);
        }

        socket = new WebSocket(url);

        // Connection opened
        socket.addEventListener('open', function (event) {
            console.info("(BeardedSpice Control) Socket open.");
            socketConnected = true;
            if (timeoutObject) {
                clearTimeout(timeoutObject);
                timeoutObject = null;
            }
            // send accepters request after timeout
            setTimeout(function(){_send({'request':'accepters'});}, SOCKET_TIMEOUT);
        });

        // Listen for messages
        socket.addEventListener('message', function (event) {
            console.log('(BeardedSpice Control) Message from server ', event.data);
            try {

                var obj = JSON.parse(event.data);
                if (obj['accepters']) {
                        //got accepters
                        safari.extension.settings.accepters = obj['accepters'];
                        _send({'request':'port'});
                }
                else if (obj['port']) {
                    //got clients port
                    clientsPort = obj['port'];
                    _sendOk();
                    // Send new port to tabs
                    tabs.forEach(function(tab, val, set){tab.page.dispatchMessage("reconnect", {'result':true});});
                }
                else if (obj['test']) {
                    safari.application.activeBrowserWindow.activate();
                }
                else {
                    console.error('(BeardedSpice Control) response not found.');
                    throw "(BeardedSpice Control) response not found.";
                }
            } catch (ex) {
                logError(ex);
                _send({'result':false});
                socket.close();
            }
        });

        var onSocketDisconnet = function (event) {
            console.log('(BeardedSpice Control) onSocketDisconnet');
            if (socketConnected) {
                _clean();
                timeoutObject = setTimeout(reconnect, RECONNECT_TIMEOUT);
            }
        };

        socket.addEventListener('close', onSocketDisconnet);
        // socket.addEventListener('error', onSocketDisconnet);

        timeoutObject = setTimeout(connectTimeout, SOCKET_TIMEOUT);
    } 

    function respondToMessage(theMessageEvent) {
        if (theMessageEvent.target.page) {
            console.log('(BeardedSpice Control) respondToMessage event: ' + theMessageEvent.name + ' target: ' + theMessageEvent.target.title );
            //request accepters
            if(theMessageEvent.name === "accepters") {
                theMessageEvent.target.page.dispatchMessage("accepters", safari.extension.settings.accepters);
            }
            // request port
            else if (theMessageEvent.name === "port") {
                theMessageEvent.target.addEventListener("close", function(event){
                    tabs.delete(event.target);
                    console.log('(BeardedSpice Control) Tab removed from tabs onClose: \n' + event.target.title);
                }, false);
                theMessageEvent.target.addEventListener("beforeNavigate", function(event){
                    tabs.delete(event.target);
                    console.log('(BeardedSpice Control) Tab removed from tabs onbeforeNavigate: \n' + event.target.title);
                }, false);
                tabs.add(theMessageEvent.target);

                theMessageEvent.target.page.dispatchMessage("port", {'result':clientsPort});
            }
            else if (theMessageEvent.name === "frontmost") {
                var result = safari.application.activeBrowserWindow.activeTab === theMessageEvent.target;
                theMessageEvent.target.page.dispatchMessage("frontmost", {'result':result});
            }
            else if (theMessageEvent.name === "bundleId") {

                theMessageEvent.target.page.dispatchMessage("bundleId", {'result':safari.extension.settings.hostBundleId});
            }
            else if (theMessageEvent.name === "serverIsAlive") {
                if (socket && clientsPort) {
                    theMessageEvent.target.page.dispatchMessage("reconnect", {'result':true});   
                }
            }
        }
    }

    connect(controlPort);

    safari.application.addEventListener("message",respondToMessage,false);

</script>
</head>
<body>
</body>
</html>
